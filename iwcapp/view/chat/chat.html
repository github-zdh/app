<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
        <script src="../../contronller/init.js"></script>
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/style.css">
		<link rel="stylesheet" href="../../css/index.css">
		<style>
			  .mui-bar-nav{
			 	background: #333333;
			 	box-shadow: none;
			 }
			 .mui-bar .mui-title,.mui-bar-nav.mui-bar .mui-icon{color: #fff;}
			 #content{position:fixed;top:45px;bottom:45px;width:100%;overflow-y: scroll;}
			 #footer{position:fixed;bottom:0px;width:100%;height: 45px;}
			 
		</style>

	</head>

	<body onselectstart="return false;">
		<div id="openWindow">
			<header class="mui-bar mui-bar-nav">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
				<h1 class="mui-title mui-text-left"></h1>
				<a class="mui-icon-contact mui-icon mui-pull-right"></a>
			</header>
		</div>
		<div style="height: 100px;"></div>
		<div id="socket"></div>
		<div><input type="text" id="chatmsg"><button id="send">send</button></div>
		<script src="../../socket.io/socket.io.js"></script>
		<script type="text/javascript">
		   var username = Math.random().toString().split('.')[1] ;
		   var socDom = function(el){
		   	   return document.getElementById(el)
		   };
		   var socEl = function(html){
		   	  var el = document.createElement('h1');
		   	  el.innerHTML = html;
		   	  socDom('socket').appendChild(el);
		   }
		   var localhost = 'http://localhost:3000/room';
		   // var localhost = 'http://114.115.137.212:3000/room';
		   var room = io.connect(localhost);
		   room.on('connect',function(){
				//连接成功
				room.emit('room join',{username:username});
			});  

		   room.on('room sys', function (data,ioRooms,room) {
		        socEl(data)
		   });
		   socDom('send').addEventListener('click',function(){
		   	    var sendMsg = socDom('chatmsg').value;
		   	    console.log(sendMsg);
		   	    room.emit('room sendMsg', sendMsg);
		   })
		   room.on('room msg', function (data) {

		        console.log(JSON.stringify(data));
		        socEl(data['from']['username']+'---'+data['msg'])
		   });
		   // 未读消息
		   room.on('room unread',function(data){
		   	    // console.log('room unread-------'+JSON.stringify(data));
		   	    for(var i=0;i<data.length;i++){
                     socEl(data[i]['from']['username']+'---'+data[i]['msg'])
		   	    }
		   })
		</script>
		
		<script src="../../js/mui.min.js"></script>
		<script src="../../contronller/config.js"></script>
		<script src="../../contronller/common.js"></script>
		<script src="../../js/mui.md5.js"></script>
		<script src="../../contronller/createView.js"></script>
		
		<script>
				mui.init({
					swipeBack: false,
					keyEventBind: {
						backbutton: true //关闭back按键监听
					}
				});

//			    //关闭等待框
//			     plus.nativeUI.closeWaiting();
//			     //显示当前页面
//			     mui.currentWebview.show();
//				 //显示聊天人物
//				 mui('header h1')[0].innerHTML = plus.webview.currentWebview().id;
//				 mui.scrollTo(100000,300);	


			mui.plusReady(function() {
				// 隐藏滚动条
				plus.webview.currentWebview().setStyle({scrollIndicator:'none'});
				//加载动画
				setTimeout(function(){
					 plus.nativeUI.showWaiting()
				},300)
				
				var _time = new Date().getTime();
				var _str = '208476fb571a4103d4deea31684d18378F923ED924BC997E36DF2483DE35ED6Fpublicnumber/index208476fb571a4103d4deea31684d18378F923ED924BC997E36DF2483DE35ED6F'+_time;
	            var _key = md5(_str).toUpperCase();
				mui.ajax('https://nphapi.igango.com/home/Publicnumber/index',{
						data:{
							"key":_key,
							"time":_time,
							page:1,
							page_size:10
						},
						dataType:'JSON',//服务器返回json格式数据
						type:'get',//HTTP请求类型
						timeout:100000,//超时时间设置为100秒；	              
						success:function(data){
	//						alert('success');
							var data = JSON.parse(data);
							document.getElementById('html').innerHTML = data.result[0].content;
							setTimeout(function(){
								 plus.nativeUI.closeWaiting();
							},1000)
						},
						error:function(xhr,type,errorThrown){
							//异常处理；
	//						alert(type);
							console.log(JSON.stringify(xhr))
						}
				});

			})
		</script>

	</body>

</html>
